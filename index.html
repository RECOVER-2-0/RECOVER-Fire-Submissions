
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>RECOVER 2.0: Community Submitted Fires</title>
    <link rel="icon" type="image/x-icon" href="https://www.isu.edu/media/top-level/images/favicon.ico">

    <link rel="stylesheet" href="https://js.arcgis.com/4.26/esri/themes/light/main.css">
    <link rel="stylesheet" href="index.css">
    
    <!-- START ARCADE EXPRESSIONS -->
    <script type = "text/plain" id="state">
      if (IsEmpty(Geometry($feature))) {
        return;
      }
      var states = Intersects(FeatureSetByName($map, "Western States"), $feature);
      
      if (IsEmpty(states)) {
        return null;
      } 
      
      if (Count(states) == 1) {
        var state = First(states);
        return state.STATE_ABBR;
      } else {
        var largest = -1;
        var result;

        for (var state in states) {
          var size = Area(Intersection($feature, state));

          if (size > largest) {
            largest = size;
            result = state.STATE_ABBR;
          }
        }
        return result;
      }
    </script>
    
    <script type="text/plain" id="nearest-city">
      if (isEmpty(Geometry($feature))) {
        return;
      }
      
      // Buffer distance in miles 
      var bufferDist = 300;
      var bufferGeom = Buffer($feature, bufferDist, "miles")
      
      // Find nearby major cities
      var cities = Intersects(FeatureSetByName($map, "Cities", ["NAME"], true), bufferGeom);
      
      // return if no results
      if (Count(cities) == 0) {
        return null;
      }
      
      var nearestCity
      var minDistance = Infinity;
      
      // iterate through city points
      for (var city in cities) {
        var cityDistance = Distance(city, $feature, "miles");
        
        if (cityDistance < minDistance) {
          nearestCity = city;
          minDistance = cityDistance;
        }
      }
      
      // return city name from nearest city
      return Proper(nearestCity.NAME);
    </script>
    
    <script type = "text/plain" id="uid">
      if (IsEmpty($feature.State) || IsEmpty($feature.Fire_Name) || IsEmpty($feature.Fire_Year)) {
        return;
      }
      var fYear = $feature.Fire_Year;
      var stateAbbr = $feature.State;
      var nameSubstr = Left($feature.Fire_Name, 3);
      var subPre = "SUB_";
      
      var uniqueID = Upper(Concatenate([subPre, fYear, "_", stateAbbr, nameSubstr]));
      
      return uniqueID;
    </script>

    <script type = "text/plain" id="validation">

      var subEmail = $feature.Sub_Email;
      
      var banned = [33,35,36,37,38,39,42,43,45,47,61,63,94,95,96,123,124,125,126,34,40,41,44,58,59,60,62,91,92,93];
      var tlds = [".com", ".org", ".net", ".int", ".edu", ".gov", ".mil"];
      
      function findTld (email) {
        var tld = Right(email, 4)
        if (Includes(tlds, tld)) {
          return 1;
        } else {
          return 0;
        }
      }
      
      var splitEmail = Split(subEmail, "@");
      var atCount = Count(splitEmail);

      var inEmail = [];
      for (var char in subEmail) {
        var inEmailCC = ToCharCode(subEmail, char)
        Push(inEmail, inEmailCC)
      };

      for (var char in inEmail) {
        if (Includes(banned, inEmail[char]) || (Find("@", subEmail) == -1) || findTld(subEmail) == 0 || atCount != 2) {
          return "Invalid";
        }
      };

      if (IsEmpty(subEmail)) {
        return "Invalid";
      }
      

      return "Valid";

    </script>

    <!-- END ARCADE EXPRESSIONS -->

  </head>
  <body>
    <div class="header">
      <img src="https://www.arcgis.com/sharing/rest/content/items/18fb54a427d449c08dc79ba4a650d636/resources/images/widget_159/1683741702207.png" alt="NASA RECOVER 2.0 logo"/>Community Fire Submissions
    </div>
    <div id="viewDiv">
      <div id="aboutDiv">
        <h1>About</h1>
        <p>
          Welcome to the NASA RECOVER 2.0 Community Fire Submissions web mapping application. The
          purpose of this application is to allow members of the post-wildfire management and forestry
          communities to submit fires for inclusion in RECOVER. These fires could be new fires that are
          not large enough to be caught by the Large Fire Trigger (which populates the RECOVER_Fires 
          hosted feature layer found in the RECOVER 2.0 dashboard and creates their associated downloadable
          data packages), older fires for which RECOVER data packages were not created, or other fires. 
        </p>
        <h4>How it works</h4>
        <p>
          This application works by allowing users to submit fire shapes and additional information.
          Using the Editor widget in the top-right corner of the screen, users can draw new shapes or
          edit existing shapes. After collecting some information including fire name, location, and 
          user contact information, the submitted fire shape is displayed on the map and created in 
          the Community Fire Submissions hosted feature layer. This hosted feature layer is consumed 
          by the Large Fire Trigger on a nightly basis and the submitted fire shape will be made 
          available for download in the RECOVER Dashboard the next morning. Note that adjustments to 
          the submitted fire will overwrite the existing data package.
        </p>
      </div>
    </div>
    <script type ="module" src="/index.js"></script>
  </body>
</html>

